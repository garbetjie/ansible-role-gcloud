---

# Enable auto-scaling.
-
  name: "Enable auto-scaling for managed instance group '{{ instance_group.name }}'."
  when: instance_group.autoscale is defined and instance_group.autoscale
  shell: |
    gcloud beta compute instance-groups managed set-autoscaling {{ instance_group.name }} \
    {% if instance_group.zone is defined %} --zone="{{ instance_group.zone }}" {% endif %} \
    {% if instance_group.region is defined %} --region="{{ instance_group.region }}" {% endif %} \
    {% if instance_group.autoscale.min_replicas is defined %} --min-num-replicas="{{ instance_group.autoscale.min_replicas }}" {% endif %} \
    {% if instance_group.autoscale.max_replicas is defined %} --max-num-replicas="{{ instance_group.autoscale.max_replicas }}" {% endif %} \
    {% if instance_group.autoscale.cooldown is defined %} --cool-down-period="{{ instance_group.autoscale.cooldown }}" {% endif %} \
    {% if instance_group.autoscale.custom_metric is defined %} --custom-metric-utilization="{{ instance_group.autoscale.metric_utilization|join(',') }}" {% endif %} \
    {% if instance_group.autoscale.description is defined %} --description="{{ instance_group.autoscale.description }}" {% endif %} \
    {% if instance_group.autoscale.scale_cpu is defined %} --scale-based-on-cpu --target-cpu-utilization="{{ instance_group.autoscale.scale_cpu }}" {% endif %} \
    {% if instance_group.autoscale.scale_load_balancing is defined %} --scale-based-on-load-balancing --target-load-balancing-utilization="{{ instance_group.sautoscale.cale_load_balancing }}" {% endif %} \

# Disable auto-scaling.
-
  name: "Disable auto-scaling on managed instance group {{ instance_group.name }}."
  when: instance_group.autoscale is defined and not instance_group.autoscale
  register: disable_autoscale_result
  failed_when: "'Deleted [' not in disable_autoscale_result.stderr and 'The managed instance group is not autoscaled' not in disable_autoscale_result.stderr"
  shell: |
    gcloud beta compute instance-groups managed stop-autoscaling {{ instance_group.name }} \
    {% if instance_group.zone is defined %} --zone="{{ instance_group.zone }}"{% endif %} \
    {% if instance_group.region is defined %} --region="{{ instance_group.region }}"{% endif %}

# Resize the instance group.
-
  name: "Set size of managed instance group '{{ instance_group.name }}'."
  when: instance_group.autoscale is not defined or not instance_group.autoscale or (instance_group.autoscale and instance_group.size >= instance_group.autoscale.min_replicas)
  shell: |
    gcloud beta compute instance-groups managed resize {{ instance_group.name }} \
    --size={{ instance_group.size }} \
    {% if instance_group.zone is defined %} --zone="{{ instance_group.zone }}" {% endif %} \
    {% if instance_group.region is defined %} --region="{{ instance_group.region }}" {% endif %}

# Update the instance template.
-
  name: "Set instance template of managed instance group '{{ instance_group.name }}'."
  shell: |
    gcloud beta compute instance-groups managed set-instance-template {{ instance_group.name }} \
    --template={{ instance_group.template }} \
    {% if instance_group.zone is defined %} --zone="{{ instance_group.zone }}" {% endif %} \
    {% if instance_group.region is defined %} --region="{{ instance_group.region }}" {% endif %}
